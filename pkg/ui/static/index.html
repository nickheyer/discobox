<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Discobox - Production Grade Reverse Proxy">
    <title>Discobox</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
    <div x-data="discobox()">
        <nav class="container-fluid">
            <ul>
                <li><strong>Discobox</strong></li>
            </ul>
            <ul>
                <li><a href="#" @click="showAuth = !showAuth" x-show="!apiKey">Login</a></li>
                <li><a href="#" @click="logout()" x-show="apiKey">Logout</a></li>
            </ul>
        </nav>

        <main class="container">
        <!-- Auth Modal -->
        <dialog :open="showAuth && !apiKey">
            <article>
                <header>
                    <h3>Login</h3>
                </header>
                <form @submit.prevent="login()">
                    <label>
                        Username
                        <input type="text" x-model="loginForm.username" placeholder="Enter your username" required autofocus>
                    </label>
                    <label>
                        Password
                        <input type="password" x-model="loginForm.password" placeholder="Enter your password" required>
                    </label>
                    <div x-show="loginError" role="alert" style="color: var(--del-color);">
                        <small x-text="loginError"></small>
                    </div>
                    <footer>
                        <button type="submit" :aria-busy="loggingIn">Login</button>
                    </footer>
                </form>
            </article>
        </dialog>
        
        <!-- Password Change Modal -->
        <dialog :open="showPasswordChange">
            <article>
                <header>
                    <h3>Change Password Required</h3>
                </header>
                <p>You must change your password before continuing.</p>
                <form @submit.prevent="changePassword()">
                    <label>
                        New Password
                        <input type="password" x-model="passwordForm.newPassword" placeholder="Enter new password" required autofocus>
                    </label>
                    <label>
                        Confirm Password
                        <input type="password" x-model="passwordForm.confirmPassword" placeholder="Confirm new password" required>
                    </label>
                    <div x-show="passwordError" role="alert" style="color: var(--del-color);">
                        <small x-text="passwordError"></small>
                    </div>
                    <footer>
                        <button type="submit">Change Password</button>
                    </footer>
                </form>
            </article>
        </dialog>

        <!-- Loading State -->
        <div x-show="loading" aria-busy="true">Loading...</div>

        <!-- Error Alert -->
        <article x-show="error" role="alert">
            <h4>Error</h4>
            <p x-text="error"></p>
            <button @click="error = null" class="secondary">Dismiss</button>
        </article>

        <!-- Main Content -->
        <div x-show="!loading && apiKey">
            <!-- System Status -->
            <section>
                <hgroup>
                    <h2>System Status</h2>
                    <p>Health and metrics overview</p>
                </hgroup>
                
                <div class="grid">
                    <article>
                        <header>Health</header>
                        <p><strong x-text="health.status || 'Unknown'"></strong></p>
                        <p><small>Version: <span x-text="health.version"></span></small></p>
                        <p><small>Uptime: <span x-text="health.runtime?.uptime"></span></small></p>
                    </article>
                    
                    <article>
                        <header>Requests</header>
                        <p><strong x-text="metrics.requests?.total || 0"></strong> total</p>
                        <p><small x-text="metrics.requests?.per_second?.toFixed(2) || 0"></small> req/s</p>
                        <p><small>Error rate: <span x-text="(metrics.requests?.error_rate || 0).toFixed(1)"></span>%</small></p>
                    </article>
                    
                    <article>
                        <header>System</header>
                        <p><strong x-text="(metrics.system?.cpu_percent || 0).toFixed(1)"></strong>% CPU</p>
                        <p><small x-text="(metrics.system?.memory_mb || 0).toFixed(0)"></small> MB RAM</p>
                        <p><small><span x-text="metrics.system?.goroutines || 0"></span> goroutines</small></p>
                    </article>
                </div>
            </section>

            <!-- Services -->
            <section>
                <hgroup>
                    <h2>Services</h2>
                    <p>Backend service configurations</p>
                </hgroup>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Endpoints</th>
                                <th>Health</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="service in services" :key="service.id">
                                <tr>
                                    <td>
                                        <strong x-text="service.name"></strong><br>
                                        <small x-text="service.id"></small>
                                    </td>
                                    <td>
                                        <small x-text="service.endpoints.length + ' endpoint(s)'"></small>
                                    </td>
                                    <td>
                                        <small x-text="service.health_path || 'None'"></small>
                                    </td>
                                    <td>
                                        <span x-text="service.active ? '✓' : '✗'"></span>
                                    </td>
                                    <td>
                                        <button class="secondary" @click="editService(service)">Edit</button>
                                        <button class="contrast" @click="deleteService(service.id)">Delete</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <button @click="editService(null)">Add Service</button>
            </section>

            <!-- Routes -->
            <section>
                <hgroup>
                    <h2>Routes</h2>
                    <p>Request routing rules</p>
                </hgroup>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Priority</th>
                                <th>Host</th>
                                <th>Path</th>
                                <th>Service</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="route in routes" :key="route.id">
                                <tr>
                                    <td x-text="route.priority"></td>
                                    <td><small x-text="route.host || '*'"></small></td>
                                    <td><small x-text="route.path_prefix || route.path_regex || '/'"></small></td>
                                    <td><small x-text="route.service_id"></small></td>
                                    <td>
                                        <button class="secondary" @click="editRoute(route)">Edit</button>
                                        <button class="contrast" @click="deleteRoute(route.id)">Delete</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <button @click="editRoute(null)">Add Route</button>
            </section>

            <!-- Configuration -->
            <section>
                <hgroup>
                    <h2>Configuration</h2>
                    <p>System configuration management</p>
                </hgroup>
                
                <div class="grid">
                    <div>
                        <button @click="reloadConfig()">Reload Configuration</button>
                    </div>
                    <div>
                        <button class="secondary" @click="viewConfig()">View Configuration</button>
                    </div>
                </div>
            </section>
        </div>

        <!-- Service Modal -->
        <dialog :open="showServiceModal">
            <article>
                <header>
                    <h3 x-text="editingService?.id ? 'Edit Service' : 'Add Service'"></h3>
                </header>
                <form @submit.prevent="saveService()">
                    <label>
                        ID
                        <input type="text" x-model="serviceForm.id" :disabled="editingService?.id" required>
                    </label>
                    <label>
                        Name
                        <input type="text" x-model="serviceForm.name" required>
                    </label>
                    <label>
                        Endpoints (one per line)
                        <textarea x-model="serviceForm.endpointsText" rows="3" required></textarea>
                    </label>
                    <label>
                        Health Path
                        <input type="text" x-model="serviceForm.health_path" placeholder="/health">
                    </label>
                    <div class="grid">
                        <label>
                            Weight
                            <input type="number" x-model.number="serviceForm.weight" min="1" value="1">
                        </label>
                        <label>
                            Max Connections
                            <input type="number" x-model.number="serviceForm.max_conns" min="0" value="100">
                        </label>
                    </div>
                    <label>
                        <input type="checkbox" x-model="serviceForm.active">
                        Active
                    </label>
                    <label>
                        <input type="checkbox" x-model="serviceForm.strip_prefix">
                        Strip Path Prefix
                    </label>
                    <footer>
                        <button type="button" class="secondary" @click="showServiceModal = false">Cancel</button>
                        <button type="submit">Save</button>
                    </footer>
                </form>
            </article>
        </dialog>

        <!-- Route Modal -->
        <dialog :open="showRouteModal">
            <article>
                <header>
                    <h3 x-text="editingRoute?.id ? 'Edit Route' : 'Add Route'"></h3>
                </header>
                <form @submit.prevent="saveRoute()">
                    <label>
                        ID
                        <input type="text" x-model="routeForm.id" :disabled="editingRoute?.id" required>
                    </label>
                    <label>
                        Priority
                        <input type="number" x-model.number="routeForm.priority" min="0" required>
                    </label>
                    <label>
                        Host (optional)
                        <input type="text" x-model="routeForm.host" placeholder="example.com or *.example.com">
                    </label>
                    <label>
                        Path Prefix
                        <input type="text" x-model="routeForm.path_prefix" placeholder="/">
                    </label>
                    <label>
                        Service ID
                        <select x-model="routeForm.service_id" required>
                            <option value="">Select a service</option>
                            <template x-for="service in services" :key="service.id">
                                <option :value="service.id" x-text="service.name + ' (' + service.id + ')'"></option>
                            </template>
                        </select>
                    </label>
                    <footer>
                        <button type="button" class="secondary" @click="showRouteModal = false">Cancel</button>
                        <button type="submit">Save</button>
                    </footer>
                </form>
            </article>
        </dialog>

        <!-- Config Modal -->
        <dialog :open="showConfigModal">
            <article>
                <header>
                    <h3>Configuration</h3>
                </header>
                <pre x-text="JSON.stringify(config, null, 2)"></pre>
                <footer>
                    <button @click="showConfigModal = false">Close</button>
                </footer>
            </article>
        </dialog>
        </main>

    <script>
        function discobox() {
            return {
                // State
                apiKey: localStorage.getItem('discobox_api_key') || '',
                currentUser: null,
                showAuth: false,
                showPasswordChange: false,
                loading: false,
                loggingIn: false,
                error: null,
                loginError: null,
                passwordError: null,
                
                // Data
                health: {},
                metrics: {},
                services: [],
                routes: [],
                config: {},
                
                // Modals
                showServiceModal: false,
                showRouteModal: false,
                showConfigModal: false,
                editingService: null,
                editingRoute: null,
                
                // Forms
                loginForm: {
                    username: '',
                    password: ''
                },
                passwordForm: {
                    newPassword: '',
                    confirmPassword: ''
                },
                serviceForm: {
                    id: '',
                    name: '',
                    endpointsText: '',
                    health_path: '',
                    weight: 1,
                    max_conns: 100,
                    active: true,
                    strip_prefix: false
                },
                routeForm: {
                    id: '',
                    priority: 100,
                    host: '',
                    path_prefix: '/',
                    service_id: ''
                },

                // Initialize
                init() {
                    if (this.apiKey) {
                        this.loadData();
                        // Refresh data every 5 seconds
                        setInterval(() => this.loadData(), 5000);
                    } else {
                        this.showAuth = true;
                    }
                },

                // API Helper
                async api(path, options = {}) {
                    try {
                        const response = await fetch(path, {
                            ...options,
                            headers: {
                                'X-API-Key': this.apiKey,
                                'Content-Type': 'application/json',
                                ...options.headers
                            }
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                this.logout();
                                throw new Error('Authentication failed');
                            }
                            throw new Error(`API error: ${response.status}`);
                        }

                        return response.json();
                    } catch (err) {
                        this.error = err.message;
                        throw err;
                    }
                },

                // Auth
                async login() {
                    this.loggingIn = true;
                    this.loginError = null;
                    
                    try {
                        const response = await fetch('/api/v1/auth/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.loginForm)
                        });
                        
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || 'Login failed');
                        }
                        
                        const data = await response.json();
                        this.currentUser = data.user;
                        this.apiKey = data.api_key;
                        localStorage.setItem('discobox_api_key', this.apiKey);
                        
                        // Clear form
                        this.loginForm.username = '';
                        this.loginForm.password = '';
                        this.showAuth = false;
                        
                        // Check if password change required
                        if (this.currentUser.must_change_password) {
                            this.showPasswordChange = true;
                        } else {
                            await this.loadData();
                        }
                    } catch (err) {
                        this.loginError = err.message;
                    } finally {
                        this.loggingIn = false;
                    }
                },
                
                async changePassword() {
                    this.passwordError = null;
                    
                    if (this.passwordForm.newPassword !== this.passwordForm.confirmPassword) {
                        this.passwordError = 'Passwords do not match';
                        return;
                    }
                    
                    if (this.passwordForm.newPassword.length < 8) {
                        this.passwordError = 'Password must be at least 8 characters';
                        return;
                    }
                    
                    try {
                        const response = await this.api(`/api/v1/users/${this.currentUser.id}/password`, {
                            method: 'POST',
                            body: JSON.stringify({
                                new_password: this.passwordForm.newPassword
                            })
                        });
                        
                        // Password changed successfully
                        this.showPasswordChange = false;
                        this.passwordForm.newPassword = '';
                        this.passwordForm.confirmPassword = '';
                        
                        await this.loadData();
                    } catch (err) {
                        this.passwordError = err.message;
                    }
                },

                logout() {
                    this.apiKey = '';
                    this.currentUser = null;
                    localStorage.removeItem('discobox_api_key');
                    this.showAuth = true;
                    this.health = {};
                    this.metrics = {};
                    this.services = [];
                    this.routes = [];
                },

                // Load Data
                async loadData() {
                    if (!this.apiKey) return;
                    
                    this.loading = true;
                    this.error = null;

                    try {
                        // Load health (no auth needed)
                        const healthResponse = await fetch('/health');
                        this.health = await healthResponse.json();

                        // Load authenticated data
                        const [metrics, services, routes] = await Promise.all([
                            this.api('/api/v1/metrics'),
                            this.api('/api/v1/services'),
                            this.api('/api/v1/routes')
                        ]);

                        this.metrics = metrics;
                        this.services = services;
                        this.routes = routes;
                    } catch (err) {
                        console.error('Failed to load data:', err);
                    } finally {
                        this.loading = false;
                    }
                },

                // Services
                editService(service) {
                    this.editingService = service;
                    if (service) {
                        this.serviceForm = {
                            id: service.id,
                            name: service.name,
                            endpointsText: service.endpoints.join('\n'),
                            health_path: service.health_path || '',
                            weight: service.weight || 1,
                            max_conns: service.max_conns || 100,
                            active: service.active !== false,
                            strip_prefix: service.strip_prefix || false
                        };
                    } else {
                        this.serviceForm = {
                            id: '',
                            name: '',
                            endpointsText: '',
                            health_path: '',
                            weight: 1,
                            max_conns: 100,
                            active: true,
                            strip_prefix: false
                        };
                    }
                    this.showServiceModal = true;
                },

                async saveService() {
                    const service = {
                        id: this.serviceForm.id,
                        name: this.serviceForm.name,
                        endpoints: this.serviceForm.endpointsText.split('\n').filter(e => e.trim()),
                        health_path: this.serviceForm.health_path || '',
                        weight: parseInt(this.serviceForm.weight) || 1,
                        max_conns: parseInt(this.serviceForm.max_conns) || 100,
                        active: this.serviceForm.active,
                        strip_prefix: this.serviceForm.strip_prefix,
                        timeout: 30000000000, // 30s in nanoseconds
                        metadata: {}
                    };

                    try {
                        if (this.editingService) {
                            await this.api(`/api/v1/services/${service.id}`, {
                                method: 'PUT',
                                body: JSON.stringify(service)
                            });
                        } else {
                            await this.api('/api/v1/services', {
                                method: 'POST',
                                body: JSON.stringify(service)
                            });
                        }
                        this.showServiceModal = false;
                        await this.loadData();
                    } catch (err) {
                        console.error('Failed to save service:', err);
                    }
                },

                async deleteService(id) {
                    if (!confirm(`Delete service ${id}?`)) return;
                    
                    try {
                        await this.api(`/api/v1/services/${id}`, { method: 'DELETE' });
                        await this.loadData();
                    } catch (err) {
                        console.error('Failed to delete service:', err);
                    }
                },

                // Routes
                editRoute(route) {
                    this.editingRoute = route;
                    if (route) {
                        this.routeForm = {
                            id: route.id,
                            priority: route.priority,
                            host: route.host || '',
                            path_prefix: route.path_prefix || '/',
                            service_id: route.service_id
                        };
                    } else {
                        this.routeForm = {
                            id: '',
                            priority: 100,
                            host: '',
                            path_prefix: '/',
                            service_id: ''
                        };
                    }
                    this.showRouteModal = true;
                },

                async saveRoute() {
                    const route = {
                        id: this.routeForm.id,
                        priority: parseInt(this.routeForm.priority),
                        host: this.routeForm.host || '',
                        path_prefix: this.routeForm.path_prefix || '/',
                        service_id: this.routeForm.service_id,
                        middlewares: [],
                        metadata: {}
                    };

                    try {
                        if (this.editingRoute) {
                            await this.api(`/api/v1/routes/${route.id}`, {
                                method: 'PUT',
                                body: JSON.stringify(route)
                            });
                        } else {
                            await this.api('/api/v1/routes', {
                                method: 'POST',
                                body: JSON.stringify(route)
                            });
                        }
                        this.showRouteModal = false;
                        await this.loadData();
                    } catch (err) {
                        console.error('Failed to save route:', err);
                    }
                },

                async deleteRoute(id) {
                    if (!confirm(`Delete route ${id}?`)) return;
                    
                    try {
                        await this.api(`/api/v1/routes/${id}`, { method: 'DELETE' });
                        await this.loadData();
                    } catch (err) {
                        console.error('Failed to delete route:', err);
                    }
                },

                // Config
                async reloadConfig() {
                    try {
                        await this.api('/api/v1/admin/reload', { method: 'POST' });
                        this.error = null;
                        alert('Configuration reloaded successfully');
                    } catch (err) {
                        console.error('Failed to reload config:', err);
                    }
                },

                async viewConfig() {
                    try {
                        this.config = await this.api('/api/v1/admin/config');
                        this.showConfigModal = true;
                    } catch (err) {
                        console.error('Failed to load config:', err);
                    }
                }
            };
        }
    </script>
    </div>
</body>
</html>